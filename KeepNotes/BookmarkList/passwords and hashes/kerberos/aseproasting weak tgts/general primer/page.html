<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>General Primer</title>
</head><body><a href="http://web.archive.org/web/20190312142307/https://www.harmj0y.net/blog/activedirectory/roasting-as-reps/">ASEPRoasting </a>is similar to Kerberoasting in the sense that we query accounts for TGTs, get the hash, then crack it, however in the case of ASEPRoasting there’s a very big caveat: Kerberos pre-authentication must be disabled, which is not a default setting. When you request a TGT, via a Kerberos AS-REQ message, you also supply a timestamp that is encrypted with your username and password. The Key Distribution center (KDC) then decrypts the timestamp, verifies the request is coming from that user, then continues with the authentication process. This is the pre-authentication process for Kerberos, which is obviously a problem for an attacker because we aren’t the KDC and cannot decrypt that message. Of course, this is by design, to prevent attacks, however if pre-authentication is turned off, we can send an AS-REQ to any user which will return their hashed password in return. Since pre-auth is enabled by default, it has to be manually turned off, so this is rare, however still worth mentioning. &nbsp;<br/>
<br/>
The aspect we care for the purposes of this post is something called <a href="http://web.archive.org/web/20190223142423/https://technet.microsoft.com/en-us/library/cc961961.aspx">Kerberos preauthentication</a>&nbsp;(<a href="nbk:///6938d71d-b20d-4b36-9ada-96ca110b2f90">NBK</a>). &nbsp; <br/>
<br/>
While the AS-REP <i>ticket</i>&nbsp;itself is encrypted with the <i>service</i>&nbsp;key (in this case the krbtgt hash) the AS-REP “encrypted part” is signed with the <i>client</i>&nbsp;key, i.e. the key of the user we send an AS-REQ for. If preauthentication isn’t enabled, an attacker can send an AS-REQ for any user that doesn’t have preauth required and receive a bit of encrypted material back that can be cracked offline to reveal the target user’s password. &nbsp;<br/>
&nbsp; <br/>
While people have executed brute-forcing of the AS-REQ’s PA-ENC-TIMESTAMP component of Kerberos exchanges <a href="http://web.archive.org/web/20190223142423/http://windowsitpro.com/security/prevent-password-cracking-attacks-kerberos-preauthentication-data">for well over a decade</a> (the hash format is even in Hashcat, <a href="http://web.archive.org/web/20190223142423/https://hashcat.net/wiki/doku.php?id=example_hashes">-m 7500/ ‘Kerberos 5 AS-REQ Pre-Auth’</a>) the only toolset I’ve seen that attacks RC4 AS-REPs is <a href="http://web.archive.org/web/20190223142423/http://www.exumbraops.com/layerone2016/party">Geoff’s Python toolkit</a>. We wanted something that was Windows based that also didn’t need administrative privileges on a machine to allow us flexibility in our attack workflow. We also wanted a faster way to crack these hashes. &nbsp;<br/>
<br/>
<br/>
<br/>
</body></html>