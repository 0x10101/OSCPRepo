<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Mitigations</title>
</head><body>Mitigating Factors <br/>
Accounts marked as sensitive for delegation or members of the Protected Users group are not affected by the attacks presented here, except for the <a href="http://web.archive.org/web/20190315093814/shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#when-the-stars-align-unconstrained-delegation-leads-to-rce">S4U2Self abuse</a>. However, computer accounts are affected, and in my experience they are never marked as sensitive for delegation or added to the Protected Users group. I did not thoroughly test the effects of setting computer accounts as sensitive for delegation or adding them to the Protected Users group, so I cannot recommend doing that, but I do recommend exploring it.<br/>
&nbsp;<br/>
As Lee Christensen (<a href="http://web.archive.org/web/20190315093814/https://twitter.com/tifkin_">@tifkin_</a>) demonstrated in <a href="http://web.archive.org/web/20190315093814/https://www.slideshare.net/harmj0y/derbycon-the-unintended-risks-of-trusting-active-directory/38">“the printer bug” abuse case study at DerbyCon 8</a>, obtaining a TGT/TGS for a domain controller allows performing “dcsync” and compromising the domain. As <a href="http://web.archive.org/web/20190315093814/shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#when-the-stars-align-unconstrained-delegation-leads-to-rce">demonstrated above</a>, with resource-based constrained delegation, obtaining a TGT for any computer account allows impersonating users to it and potentially compromising the host. Therefore, it is important not to configure any host for unconstrained delegation, because it can facilitate the compromise of other hosts within the forest and within other forests with bidirectional trust.<br/>
&nbsp;<br/>
<a href="http://web.archive.org/web/20190315093814/https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/domain-controller-ldap-server-signing-requirements">LDAP signing</a>&nbsp;with <a href="http://web.archive.org/web/20190315093814/https://support.microsoft.com/en-au/help/4034879/how-to-add-the-ldapenforcechannelbinding-registry-entry">channel binding</a>&nbsp;can mitigate the <a href="http://web.archive.org/web/20190315093814/shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#case-study-1-mssql-rcelpe">RCE</a>&nbsp;and <a href="http://web.archive.org/web/20190315093814/shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#case-study-2-windows-1020162019-lpe">LPE</a>&nbsp;attack chains described in the case studies above.<br/>
&nbsp;<br/>
The <a href="http://web.archive.org/web/20190315093814/shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#case-study-1-mssql-rcelpe">RCE</a>/<a href="http://web.archive.org/web/20190315093814/shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#case-study-2-windows-1020162019-lpe">LPE</a>&nbsp;attack chains that involve NTLM relay to LDAP abuse a default ACE that permits Self to write msDS-AllowedToActOnBehalfOfOtherIdentity. Adding a new ACE that denies Self from writing to the attribute msDS-AllowedToActOnBehalfOfOtherIdentity will interrupt these attack chains, which will then have to fall back to abusing that primitive in conjunction with unconstrained delegation. If your organisation does not use resource-based constrained delegation, you can consider adding an ACE that blocks Everyone from writing to the attribute msDS-AllowedToActOnBehalfOfOtherIdentity.<br/>
&nbsp; <br/>
A Word of Advice from Microsoft <br/>
Microsoft did highlight the risk of S4U2Proxy in <a href="http://web.archive.org/web/20190315093814/https://msdn.microsoft.com/en-us/library/cc246112.aspx">section 5.1</a>&nbsp;of MS-SFU:<br/>
&nbsp; <br/>
“The S4U2proxy extension allows a service to obtain a service ticket to a second service on behalf of a user. When combined with S4U2self, this allows the first service to impersonate any user principal while accessing the second service. This gives any service allowed access to the S4U2proxy extension a degree of power similar to that of the KDC itself. <b>This implies that each of the services allowed to invoke this extension have to be protected nearly as strongly as the KDC</b>&nbsp;and the services are limited to those that the implementer knows to have correct behavior.”<br/>
&nbsp; <br/>
S4U2Proxy is a dangerous extension that should be restricted as much as possible. However, the introduction of resource-based constrained delegation allows any account to permit arbitrary accounts to invoke S4U2Proxy, by configuring “incoming” delegation to itself. So should we protect all accounts as strongly as the KDC?<br/>
&nbsp; <br/>
<br/>
Detection <br/>
The following events can be used in the implementation of detection logic for the attacks describes in this post:<br/>
&nbsp;<ul><li>&nbsp;<b>S4U2Self:</b>&nbsp;S4U2Self can be detected in a Kerberos service ticket request event (Event ID 4769), where the Account Information and Service Information sections point to the same account. <a href="http://web.archive.org/web/20190315093814/http://shenaniganslabs.io/images/TrustedToAuthForDelegationWho/S4U2Self_Event.png"><img src="http://web.archive.org/web/20190315093814im_/http://shenaniganslabs.io/images/TrustedToAuthForDelegationWho/S4U2Self_Event.png" /></a></li>
<li><b>S4U2Proxy:</b>&nbsp;S4U2Proxy can be detected in a Kerberos service ticket request event (Event ID 4769), where the Transited Services attribute in the Additional Information is not blank. <a href="http://web.archive.org/web/20190315093814/http://shenaniganslabs.io/images/TrustedToAuthForDelegationWho/S4U2Proxy_Event.png"><img src="http://web.archive.org/web/20190315093814im_/http://shenaniganslabs.io/images/TrustedToAuthForDelegationWho/S4U2Proxy_Event.png" /></a></li>
<li><a href="http://web.archive.org/web/20190315093814/shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#unconstrained-domain-persistence"><b>Unconstrained Domain Persistence</b></a><b>:</b>&nbsp;The domain persistence technique <a href="http://web.archive.org/web/20190315093814/shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#unconstrained-domain-persistence">described above</a>&nbsp;can be detected in a in a Kerberos service ticket request event (Event ID 4769), where the Transited Services attribute in the Additional Information is not blank (indicating S4U2Proxy), and the Service Information points to the “krbtgt” account. <a href="http://web.archive.org/web/20190315093814/http://shenaniganslabs.io/images/TrustedToAuthForDelegationWho/Persistence_Event.png"><img src="http://web.archive.org/web/20190315093814im_/http://shenaniganslabs.io/images/TrustedToAuthForDelegationWho/Persistence_Event.png" /></a></li>
<li><b>msDS-AllowedToActOnBehalfOfOtherIdentity:</b>&nbsp;<b>If an appropriate SACL is defined</b>, then resource-based constrained delegation configuration changes can be detected in directory service object modification events (Event ID 5136), where the LDAP Display Name is “msDS-AllowedToActOnBehalfOfOtherIdentity”. Events where the subject identity and the object identity are the same may be an indicator for some of the attacks presented above. <a href="http://web.archive.org/web/20190315093814/http://shenaniganslabs.io/images/TrustedToAuthForDelegationWho/RBCD_Event.png"><img src="http://web.archive.org/web/20190315093814im_/http://shenaniganslabs.io/images/TrustedToAuthForDelegationWho/RBCD_Event.png" /></a></li>
</ul>
&nbsp;<br/>
<br/>
11/12/2018 - MSRC responded that a new case manager was assigned and the following conclusion was reached: &nbsp;<br/>
“The engineering team has determined <b>this is not an issue which will be addressed via a security update</b>&nbsp;but rather we need to update our documentation to highlight service configuration best practices and using a number of features such as group managed service accounts, resource based constrained delegation, dynamic access control, authentication policies, and ensuring unconstrained delegation is not enabled. The team is actively working on the documentation right now with the goal of having it published prior to your disclosure date.”<br/>
&nbsp; <br/>
28/01/2019 - Public disclosure<br/>
&nbsp;</body></html>