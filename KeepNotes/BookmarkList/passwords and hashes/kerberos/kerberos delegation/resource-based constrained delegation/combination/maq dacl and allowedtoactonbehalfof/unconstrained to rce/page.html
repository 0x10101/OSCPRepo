<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Unconstrained To RCE</title>
</head><body><b>When the Stars Align: Unconstrained Delegation Leads to RCE </b><br/>
As Lee Christensen (<a href="http://web.archive.org/web/20190315093814/https://twitter.com/tifkin_">@tifkin_</a>) demonstrated in <a href="http://web.archive.org/web/20190315093814/https://www.slideshare.net/harmj0y/derbycon-the-unintended-risks-of-trusting-active-directory/38">“the printer bug” abuse case study at DerbyCon 8</a>, it is possible to trick the Printer Spooler to connect back over SMB to a specified IP/hostname, by invoking the method <a href="http://web.archive.org/web/20190315093814/https://msdn.microsoft.com/en-us/library/cc244812.aspx">RpcRemoteFindFirstPrinterChangeNotification (Opnum 62)</a>.<br/>
&nbsp;<br/>
If an attacker compromises a host with unconstrained delegation, <a href="http://web.archive.org/web/20190315093814/https://www.slideshare.net/harmj0y/derbycon-the-unintended-risks-of-trusting-active-directory/41">“the printer bug”</a>&nbsp;abuse can result in remote code execution on any domain-joined Windows host with the Printer Spooler running.<br/>
&nbsp;<br/>
The abuse case would work as follows:<br/>
&nbsp;<ul><li>The attacker compromises a host with unconstrained delegation and elevates. <a href="http://web.archive.org/web/20190315093814/http://shenaniganslabs.io/images/TrustedToAuthForDelegationWho/UnconstrainedRCE1.png"><img src="http://web.archive.org/web/20190315093814im_/http://shenaniganslabs.io/images/TrustedToAuthForDelegationWho/UnconstrainedRCE1.png" /></a></li>
<li>The attacker runs the monitor/harvest module of Rubeus.</li>
<li>The attacker launches <a href="http://web.archive.org/web/20190315093814/https://github.com/leechristensen/SpoolSample">SpoolSample</a>&nbsp;or <a href="http://web.archive.org/web/20190315093814/https://gist.github.com/3xocyte/cfaf8a34f76569a8251bde65fe69dccc">dementor.py</a>&nbsp;to manipulate the Printer Spooler of the target host to delegate its TGT to the unconstrained delegation compromised host. <a href="http://web.archive.org/web/20190315093814/http://shenaniganslabs.io/images/TrustedToAuthForDelegationWho/UnconstrainedRCE2.png"><img src="http://web.archive.org/web/20190315093814im_/http://shenaniganslabs.io/images/TrustedToAuthForDelegationWho/UnconstrainedRCE2.png" /></a></li>
<li>The attacker can use the captured TGT to obtain a TGS to the target host for any user, even sensitive for delegation/protected users. <a href="http://web.archive.org/web/20190315093814/http://shenaniganslabs.io/images/TrustedToAuthForDelegationWho/UnconstrainedRCE3.png"><img src="http://web.archive.org/web/20190315093814im_/http://shenaniganslabs.io/images/TrustedToAuthForDelegationWho/UnconstrainedRCE3.png" /></a></li>
<li>The attacker obtains a TGS to the target host for a user with local administrator rights and compromises it. <a href="http://web.archive.org/web/20190315093814/http://shenaniganslabs.io/images/TrustedToAuthForDelegationWho/UnconstrainedRCE4.png"><img src="http://web.archive.org/web/20190315093814im_/http://shenaniganslabs.io/images/TrustedToAuthForDelegationWho/UnconstrainedRCE4.png" /></a>&nbsp;<a href="http://web.archive.org/web/20190315093814/http://shenaniganslabs.io/images/TrustedToAuthForDelegationWho/UnconstrainedRCE5.png"><img src="http://web.archive.org/web/20190315093814im_/http://shenaniganslabs.io/images/TrustedToAuthForDelegationWho/UnconstrainedRCE5.png" /></a>&nbsp;<a href="http://web.archive.org/web/20190315093814/http://shenaniganslabs.io/images/TrustedToAuthForDelegationWho/UnconstrainedRCE6.png"><img src="http://web.archive.org/web/20190315093814im_/http://shenaniganslabs.io/images/TrustedToAuthForDelegationWho/UnconstrainedRCE6.png" /></a></li>
</ul>
&nbsp;<br/>
<br/>
<a href="http://web.archive.org/web/20190315093814/https://youtu.be/XqxWHy9e_J8">https://youtu.be/XqxWHy9e_J8</a><br/>
&nbsp;<br/>
As Will Schroeder (<a href="http://web.archive.org/web/20190315093814/https://twitter.com/harmj0y">@harmj0y</a>) explained in his blog post <a href="http://web.archive.org/web/20190315093814/http://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/">Not A Security Boundary: Breaking Forest Trusts</a>, unconstrained delegation works across forest boundaries, making this attack effective across bidirectional forest trusts.<br/>
&nbsp; </body></html>