<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>General List</title>
</head><body>[al-khaser](https://github.com/LordNoteworthy/al-khaser) | Public malware techniques used in the wild: Virtual Machine, Emulation, Debuggers, Sandbox detection. <br/>
<br/>
Snapshot of list from Al-Khaser Repo<br/>
<br/>
<b>Anti-debugging attacks </b><ul><li>&nbsp;IsDebuggerPresent</li>
<li>CheckRemoteDebuggerPresent</li>
<li>Process Environment Block (BeingDebugged)</li>
<li>Process Environment Block (NtGlobalFlag)</li>
<li>ProcessHeap (Flags)</li>
<li>ProcessHeap (ForceFlags)</li>
<li>NtQueryInformationProcess (ProcessDebugPort)</li>
<li>NtQueryInformationProcess (ProcessDebugFlags)</li>
<li>NtQueryInformationProcess (ProcessDebugObject)</li>
<li>WudfIsAnyDebuggerPresent</li>
<li>WudfIsKernelDebuggerPresent</li>
<li>WudfIsUserDebuggerPresent</li>
<li>NtSetInformationThread (HideThreadFromDebugger)</li>
<li>NtQueryObject (ObjectTypeInformation)</li>
<li>NtQueryObject (ObjectAllTypesInformation)</li>
<li>CloseHanlde (NtClose) Invalide Handle</li>
<li>SetHandleInformation (Protected Handle)</li>
<li>UnhandledExceptionFilter</li>
<li>OutputDebugString (GetLastError())</li>
<li>Hardware Breakpoints (SEH / GetThreadContext)</li>
<li>Software Breakpoints (INT3 / 0xCC)</li>
<li>Memory Breakpoints (PAGE_GUARD)</li>
<li>Interrupt 0x2d</li>
<li>Interrupt 1</li>
<li>Parent Process (Explorer.exe)</li>
<li>SeDebugPrivilege (Csrss.exe)</li>
<li>NtYieldExecution / SwitchToThread</li>
<li>TLS callbacks</li>
<li>Process jobs</li>
<li>Memory write watching</li>
<li>Page exception breakpoint detection</li>
<li>API hook detection (module bounds based)</li>
</ul>
<b>Anti-injection </b><ul><li>&nbsp;Enumerate modules with EnumProcessModulesEx (32-bit, 64-bit, and all options)</li>
<li>Enumerate modules with ToolHelp32</li>
<li>Enumerate the process LDR structures with LdrEnumerateLoadedModules</li>
<li>Enumerate the process LDR structures directly</li>
<li>Walk memory with GetModuleInformation</li>
<li>Walk memory for hidden modules</li>
</ul>
<b>Anti-Dumping </b><ul><li>&nbsp;Erase PE header from memory</li>
<li>SizeOfImage</li>
</ul>
<b>Timing Attacks [Anti-Sandbox] </b><ul><li>&nbsp;RDTSC (with CPUID to force a VM Exit)</li>
<li>RDTSC (Locky version with GetProcessHeap &amp; CloseHandle)</li>
<li>Sleep -&gt; SleepEx -&gt; NtDelayExecution</li>
<li>Sleep (in a loop a small delay)</li>
<li>Sleep and check if time was accelerated (GetTickCount)</li>
<li>SetTimer (Standard Windows Timers)</li>
<li>timeSetEvent (Multimedia Timers)</li>
<li>WaitForSingleObject -&gt; WaitForSingleObjectEx -&gt; NtWaitForSingleObject</li>
<li>WaitForMultipleObjects -&gt; WaitForMultipleObjectsEx -&gt; NtWaitForMultipleObjects (todo)</li>
<li>IcmpSendEcho (CCleaner Malware)</li>
<li>CreateWaitableTimer</li>
<li>CreateTimerQueueTimer</li>
<li>Big crypto loops (todo)</li>
</ul>
<b>Human Interaction / Generic [Anti-Sandbox] </b><ul><li>&nbsp;Mouse movement</li>
<li>Total Physical memory (GlobalMemoryStatusEx)</li>
<li>Disk size using DeviceIoControl (IOCTL_DISK_GET_LENGTH_INFO)</li>
<li>Disk size using GetDiskFreeSpaceEx (TotalNumberOfBytes)</li>
<li>Mouse (Single click / Double click) (todo)</li>
<li>DialogBox (todo)</li>
<li>Scrolling (todo)</li>
<li>Execution after reboot (todo)</li>
<li>Count of processors (Win32/Tinba - Win32/Dyre)</li>
<li>Sandbox known product IDs (todo)</li>
<li>Color of background pixel (todo)</li>
<li>Keyboard layout (Win32/Banload) (todo)</li>
</ul>
<b>Anti-Virtualization / Full-System Emulation </b><ul><li><b>Registry key value artifacts</b></li>
<li style="list-style-type: none"><ul><li>&nbsp;HARDWARE\DEVICEMAP\Scsi\Scsi Port 0\Scsi Bus 0\Target Id 0\Logical Unit Id 0 (Identifier) (VBOX)</li>
<li>HARDWARE\DEVICEMAP\Scsi\Scsi Port 0\Scsi Bus 0\Target Id 0\Logical Unit Id 0 (Identifier) (QEMU)</li>
<li>HARDWARE\Description\System (SystemBiosVersion) (VBOX)</li>
<li>HARDWARE\Description\System (SystemBiosVersion) (QEMU)</li>
<li>HARDWARE\Description\System (VideoBiosVersion) (VIRTUALBOX)</li>
<li>HARDWARE\Description\System (SystemBiosDate) (06/23/99)</li>
<li>HARDWARE\DEVICEMAP\Scsi\Scsi Port 0\Scsi Bus 0\Target Id 0\Logical Unit Id 0 (Identifier) (VMWARE)</li>
<li>HARDWARE\DEVICEMAP\Scsi\Scsi Port 1\Scsi Bus 0\Target Id 0\Logical Unit Id 0 (Identifier) (VMWARE)</li>
<li>HARDWARE\DEVICEMAP\Scsi\Scsi Port 2\Scsi Bus 0\Target Id 0\Logical Unit Id 0 (Identifier) (VMWARE)</li>
<li>SYSTEM\ControlSet001\Control\SystemInformation (SystemManufacturer) (VMWARE)</li>
<li>SYSTEM\ControlSet001\Control\SystemInformation (SystemProductName) (VMWARE)</li>
</ul>
</li>
<li><b>Registry Keys artifacts</b></li>
<li style="list-style-type: none"><ul><li>&nbsp;HARDWARE\ACPI\DSDT\VBOX__ (VBOX)</li>
<li>HARDWARE\ACPI\FADT\VBOX__ (VBOX)</li>
<li>HARDWARE\ACPI\RSDT\VBOX__ (VBOX)</li>
<li>SOFTWARE\Oracle\VirtualBox Guest Additions (VBOX)</li>
<li>SYSTEM\ControlSet001\Services\VBoxGuest (VBOX)</li>
<li>SYSTEM\ControlSet001\Services\VBoxMouse (VBOX)</li>
<li>SYSTEM\ControlSet001\Services\VBoxService (VBOX)</li>
<li>SYSTEM\ControlSet001\Services\VBoxSF (VBOX)</li>
<li>SYSTEM\ControlSet001\Services\VBoxVideo (VBOX)</li>
<li>SOFTWARE\VMware, Inc.\VMware Tools (VMWARE)</li>
<li>SOFTWARE\Wine (WINE)</li>
<li>SOFTWARE\Microsoft\Virtual Machine\Guest\Parameters (HYPER-V)</li>
</ul>
</li>
<li><b>File system artifacts</b></li>
<li style="list-style-type: none"><ul><li>&nbsp;"system32\drivers\VBoxMouse.sys"</li>
<li>"system32\drivers\VBoxGuest.sys"</li>
<li>"system32\drivers\VBoxSF.sys"</li>
<li>"system32\drivers\VBoxVideo.sys"</li>
<li>"system32\vboxdisp.dll"</li>
<li>"system32\vboxhook.dll"</li>
<li>"system32\vboxmrxnp.dll"</li>
<li>"system32\vboxogl.dll"</li>
<li>"system32\vboxoglarrayspu.dll"</li>
<li>"system32\vboxoglcrutil.dll"</li>
<li>"system32\vboxoglerrorspu.dll"</li>
<li>"system32\vboxoglfeedbackspu.dll"</li>
<li>"system32\vboxoglpackspu.dll"</li>
<li>"system32\vboxoglpassthroughspu.dll"</li>
<li>"system32\vboxservice.exe"</li>
<li>"system32\vboxtray.exe"</li>
<li>"system32\VBoxControl.exe"</li>
<li>"system32\drivers\vmmouse.sys"</li>
<li>"system32\drivers\vmhgfs.sys"</li>
<li>"system32\drivers\vm3dmp.sys"</li>
<li>"system32\drivers\vmci.sys"</li>
<li>"system32\drivers\vmhgfs.sys"</li>
<li>"system32\drivers\vmmemctl.sys"</li>
<li>"system32\drivers\vmmouse.sys"</li>
<li>"system32\drivers\vmrawdsk.sys"</li>
<li>"system32\drivers\vmusbmouse.sys"</li>
</ul>
</li>
<li><b>Directories artifacts</b></li>
<li style="list-style-type: none"><ul><li>&nbsp;"%PROGRAMFILES%\oracle\virtualbox guest additions\"</li>
<li>"%PROGRAMFILES%\VMWare\"</li>
</ul>
</li>
<li><b>Memory artifacts</b></li>
<li style="list-style-type: none"><ul><li>&nbsp;Interupt Descriptor Table (IDT) location</li>
<li>Local Descriptor Table (LDT) location</li>
<li>Global Descriptor Table (GDT) location</li>
<li>Task state segment trick with STR</li>
</ul>
</li>
<li><b>MAC Address</b></li>
<li style="list-style-type: none"><ul><li>&nbsp;"\x08\x00\x27" (VBOX)</li>
<li>"\x00\x05\x69" (VMWARE)</li>
<li>"\x00\x0C\x29" (VMWARE)</li>
<li>"\x00\x1C\x14" (VMWARE)</li>
<li>"\x00\x50\x56" (VMWARE)</li>
<li>"\x00\x1C\x42" (Parallels)</li>
<li>"\x00\x16\x3E" (Xen)</li>
<li>"\x0A\x00\x27" (Hybrid Analysis)</li>
</ul>
</li>
<li><b>Virtual devices</b></li>
<li style="list-style-type: none"><ul><li>&nbsp;"\\.\VBoxMiniRdrDN"</li>
<li>"\\.\VBoxGuest"</li>
<li>"\\.\pipe\VBoxMiniRdDN"</li>
<li>"\\.\VBoxTrayIPC"</li>
<li>"\\.\pipe\VBoxTrayIPC")</li>
<li>"\\.\HGFS"</li>
<li>"\\.\vmci"</li>
</ul>
</li>
<li><b>Hardware Device information</b></li>
<li style="list-style-type: none"><ul><li>&nbsp;SetupAPI SetupDiEnumDeviceInfo (GUID_DEVCLASS_DISKDRIVE) </li>
<li style="list-style-type: none"><ul><li>&nbsp;QEMU</li>
<li>VMWare</li>
<li>VBOX</li>
<li>VIRTUAL HD</li>
</ul>
</li>
<li>Power policies (S1-S4 states, thermal control)</li>
</ul>
</li>
<li><b>System Firmware Tables</b></li>
<li style="list-style-type: none"><ul><li>&nbsp;SMBIOS string checks (VirtualBox)</li>
<li>SMBIOS string checks (VMWare)</li>
<li>SMBIOS string checks (Qemu)</li>
<li>ACPI string checks (VirtualBox)</li>
<li>ACPI string checks (VMWare)</li>
<li>ACPI string checks (Qemu)</li>
</ul>
</li>
<li><b>Driver Services</b></li>
<li style="list-style-type: none"><ul><li>&nbsp;VirtualBox</li>
<li>VMWare</li>
</ul>
</li>
<li><b>Adapter name</b></li>
<li style="list-style-type: none"><ul><li>&nbsp;VMWare</li>
</ul>
</li>
<li><b>Windows Class</b></li>
<li style="list-style-type: none"><ul><li>&nbsp;VBoxTrayToolWndClass</li>
<li>VBoxTrayToolWnd</li>
</ul>
</li>
<li><b>Network shares</b></li>
<li style="list-style-type: none"><ul><li>&nbsp;VirtualBox Shared Folders</li>
</ul>
</li>
<li><b>Processes</b></li>
<li style="list-style-type: none"><ul><li>&nbsp;vboxservice.exe (VBOX)</li>
<li>vboxtray.exe (VBOX)</li>
<li>vmtoolsd.exe(VMWARE)</li>
<li>vmwaretray.exe(VMWARE)</li>
<li>vmwareuser(VMWARE)</li>
<li>VGAuthService.exe (VMWARE)</li>
<li>vmacthlp.exe (VMWARE)</li>
<li>vmsrvc.exe(VirtualPC)</li>
<li>vmusrvc.exe(VirtualPC)</li>
<li>prl_cc.exe(Parallels)</li>
<li>prl_tools.exe(Parallels)</li>
<li>xenservice.exe(Citrix Xen)</li>
<li>qemu-ga.exe (QEMU)</li>
</ul>
</li>
<li><b>WMI</b></li>
<li style="list-style-type: none"><ul><li>&nbsp;SELECT * FROM Win32_Bios (SerialNumber) (GENERIC)</li>
<li>SELECT * FROM Win32_PnPEntity (DeviceId) (VBOX)</li>
<li>SELECT * FROM Win32_NetworkAdapterConfiguration (MACAddress) (VBOX)</li>
<li>SELECT * FROM Win32_NTEventlogFile (VBOX)</li>
<li>SELECT * FROM Win32_Processor (NumberOfCores and ProcessorId) (GENERIC)</li>
<li>SELECT * FROM Win32_LogicalDisk (Size) (GENERIC)</li>
<li>SELECT * FROM Win32_ComputerSystem (Model and Manufacturer) (GENERIC)</li>
<li>SELECT * FROM MSAcpi_ThermalZoneTemperature CurrentTemperature) (GENERIC)</li>
<li>SELECT * FROM Win32_Fan (GENERIC)</li>
</ul>
</li>
<li><b>DLL Exports and Loaded DLLs</b></li>
<li style="list-style-type: none"><ul><li>&nbsp;avghookx.dll (AVG)</li>
<li>avghooka.dll (AVG)</li>
<li>snxhk.dll (Avast)</li>
<li>kernel32.dll!wine_get_unix_file_nameWine (Wine)</li>
<li>sbiedll.dll (Sandboxie)</li>
<li>dbghelp.dll (MS debugging support routines)</li>
<li>api_log.dll (iDefense Labs)</li>
<li>dir_watch.dll (iDefense Labs)</li>
<li>pstorec.dll (SunBelt Sandbox)</li>
<li>vmcheck.dll (Virtual PC)</li>
<li>wpespy.dll (WPE Pro)</li>
<li>cmdvrt32.dll (Comodo Container)</li>
<li>cmdvrt64.dll (Comodo Container)</li>
</ul>
</li>
<li><b>CPU</b></li>
<li style="list-style-type: none"><ul><li>&nbsp;Hypervisor presence using (EAX=0x1)</li>
<li>Hypervisor vendor using (EAX=0x40000000) </li>
<li style="list-style-type: none"><ul><li>&nbsp;"KVMKVMKVM\0\0\0" (KVM) </li>
<li style="list-style-type: none"><ul><li>&nbsp;"Microsoft Hv"(Microsoft Hyper-V or Windows Virtual PC)</li>
<li>"VMwareVMware"(VMware)</li>
<li>"XenVMMXenVMM"(Xen)</li>
<li>"prl hyperv "( Parallels) -"VBoxVBoxVBox"( VirtualBox)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>NtQueryLicenseValue with Kernel-VMDetection-Private as license value.</li>
</ul>
<b>Anti-Analysis </b><ul><li><b>Processes</b></li>
<li style="list-style-type: none"><ul><li>&nbsp;OllyDBG / ImmunityDebugger / WinDbg / IDA Pro</li>
<li>SysInternals Suite Tools (Process Explorer / Process Monitor / Regmon / Filemon, TCPView, Autoruns)</li>
<li>Wireshark / Dumpcap</li>
<li>ProcessHacker / SysAnalyzer / HookExplorer / SysInspector</li>
<li>ImportREC / PETools / LordPE</li>
<li>JoeBox Sandbox</li>
</ul>
</li>
</ul>
<b>Macro malware attacks </b><ul><li>&nbsp;Document_Close / Auto_Close.</li>
<li>Application.RecentFiles.Count</li>
</ul>
<b>Code/DLL Injections techniques </b><ul><li>&nbsp;CreateRemoteThread</li>
<li>SetWindowsHooksEx</li>
<li>NtCreateThreadEx</li>
<li>RtlCreateUserThread</li>
<li>APC (QueueUserAPC / NtQueueApcThread)</li>
<li>RunPE (GetThreadContext / SetThreadContext)</li>
</ul>
&nbsp;</body></html>