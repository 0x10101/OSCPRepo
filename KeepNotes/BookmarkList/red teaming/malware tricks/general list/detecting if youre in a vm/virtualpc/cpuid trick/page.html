<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>CPUID Trick</title>
</head><body>//http://waleedassar.blogspot.com (@waleedassar)<br/>
//A method to detect VirtualPC<br/>
#include "stdafx.h"<br/>
#include "windows.h"<br/>
#include "stdio.h"<br/>
<br/>
int __cdecl Handler(EXCEPTION_RECORD* pRec,void* est,unsigned char* pContext,void* disp)<br/>
{<br/>
&#09;if(pRec-&gt;ExceptionCode==EXCEPTION_SINGLE_STEP)<br/>
&#09;{<br/>
&#09;&#09;return ExceptionContinueExecution;<br/>
&#09;}<br/>
&#09;return ExceptionContinueSearch;<br/>
}<br/>
<br/>
<br/>
int main(int argc, char* argv[])<br/>
{<br/>
&#09;unsigned long x=0;<br/>
&#09;__asm<br/>
&#09;{<br/>
&#09;&#09;push offset Handler<br/>
&#09;&#09;push dword ptr fs:[0x0]<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mov dword ptr fs:[0x0],esp<br/>
<br/>
&#09;&#09;pushad<br/>
&#09;&#09;xor eax,eax<br/>
&#09;&#09;xor ecx,ecx<br/>
&#09;&#09;xor edx,edx<br/>
&#09;&#09;xor ebx,ebx<br/>
&#09;&#09;pushfd<br/>
&#09;&#09;pop esi<br/>
&#09;&#09;or esi,0x100 ;Trap flag<br/>
&#09;&#09;push esi<br/>
&#09;&#09;popfd<br/>
&#09;&#09;CPUID<br/>
&#09;&#09;pushfd<br/>
&#09;&#09;pop eax<br/>
&#09;&#09;mov x,eax<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; popad<br/>
&#09;&#09;pop dword ptr fs:[0x0]<br/>
&#09;&#09;pop eax<br/>
&nbsp; &nbsp; }<br/>
&nbsp; &nbsp; if(x&amp;0x100)<br/>
&nbsp; &nbsp; {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; MessageBox(0,"Virtual Machine detected","waliedassar",0);<br/>
&nbsp; &nbsp; &nbsp; &nbsp; ExitProcess(3);<br/>
&nbsp; &nbsp; }<br/>
&nbsp; &nbsp; return 0;<br/>
}</body></html>