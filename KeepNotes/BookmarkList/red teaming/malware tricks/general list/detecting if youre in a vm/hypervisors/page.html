<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Hypervisors</title>
</head><body>//http://waleedassar.blogspot.com (@waleedassar)<br/>
//Detect Hypervisors<br/>
#include "stdafx.h"<br/>
#include "windows.h"<br/>
#include "stdio.h"<br/>
<br/>
int main(int argc, char* argv[])<br/>
{<br/>
&#09;bool x=0;<br/>
&#09;__asm<br/>
&#09;{<br/>
&nbsp; &nbsp; &nbsp; &nbsp; pushad<br/>
&nbsp; &nbsp; &nbsp; &nbsp; pushfd<br/>
&nbsp; &nbsp; &nbsp; &nbsp; pop eax<br/>
&nbsp; &nbsp; &nbsp; &nbsp; or eax,0x00200000<br/>
&nbsp; &nbsp; &nbsp; &nbsp; push eax<br/>
&nbsp; &nbsp; &nbsp; &nbsp; popfd<br/>
&nbsp; &nbsp; &nbsp; &nbsp; pushfd<br/>
&nbsp; &nbsp; &nbsp; &nbsp; pop eax<br/>
&nbsp; &nbsp; &nbsp; &nbsp; and eax,0x00200000<br/>
&nbsp; &nbsp; &nbsp; &nbsp; jz CPUID_NOT_SUPPORTED ;Are you still alive?<br/>
&nbsp; &nbsp; &nbsp; &nbsp; xor eax,eax<br/>
&nbsp; &nbsp; &nbsp; &nbsp; xor edx,edx<br/>
&nbsp; &nbsp; &nbsp; &nbsp; xor ecx,ecx<br/>
&nbsp; &nbsp; &nbsp; &nbsp; xor ebx,ebx<br/>
&nbsp; &nbsp; &nbsp; &nbsp; inc eax ;processor info and feature bits<br/>
&nbsp; &nbsp; &nbsp; &nbsp; cpuid<br/>
&nbsp; &nbsp; &nbsp; &nbsp; test ecx,0x80000000 ;Hypervisor present<br/>
&nbsp; &nbsp; &nbsp; &nbsp; jnz Hypervisor<br/>
&nbsp; &nbsp; &nbsp; &nbsp; mov x,0<br/>
&nbsp; &nbsp; &nbsp; &nbsp; jmp bye<br/>
Hypervisor:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; mov x,1<br/>
&nbsp; &nbsp; &nbsp; &nbsp; jmp bye<br/>
CPUID_NOT_SUPPORTED:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; mov x,2<br/>
bye:<br/>
&nbsp; &nbsp; &nbsp; &nbsp; popad<br/>
&nbsp; &nbsp; }<br/>
&nbsp; &nbsp; if(x==1)<br/>
&nbsp; &nbsp; {<br/>
&nbsp; &nbsp; &nbsp; &nbsp; MessageBox(0,"Hypervisor detected","waliedassar",0);<br/>
&nbsp; &nbsp; &nbsp; &nbsp; ExitProcess(3);<br/>
&nbsp; &nbsp; }<br/>
&nbsp; &nbsp; return 0;<br/>
}</body></html>