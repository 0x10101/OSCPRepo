<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Bios Brand and Version 2</title>
</head><body>//http://waleedassar.blogspot.com (@waleedassar)<br/>
//Reading "SMBiosData" to extract Bios Brand and Bios Version strings via WMI COM access. If the Bios Brand string is //"innotek GmbH" or Bios Version is "VirtualBox", then it is a sign that we are running in VirtualBox.<br/>
<br/>
#include "stdafx.h"<br/>
#include &lt;comdef.h&gt;<br/>
#include &lt;Wbemidl.h&gt;<br/>
#include "stdio.h"<br/>
<br/>
#pragma comment(lib, "wbemuuid.lib")<br/>
<br/>
<br/>
void AllToUpper(unsigned char* str,unsigned long len)<br/>
{<br/>
&#09;for(unsigned long c=0;c&lt;len;c++)<br/>
&#09;{<br/>
&#09;&#09;if(str[c]&gt;='a' &amp;&amp; str[c]&lt;='z')<br/>
&#09;&#09;{<br/>
&#09;&#09;&#09;str[c]-=32;<br/>
&#09;&#09;}<br/>
&#09;}<br/>
}<br/>
<br/>
unsigned char* ScanDataForString(unsigned char* data,unsigned long data_length,unsigned char* string2)<br/>
{<br/>
&#09;unsigned long string_length=(unsigned long)strlen((char*)string2);<br/>
&#09;for(unsigned long i=0;i&lt;=(data_length-string_length);i++)<br/>
&#09;{<br/>
&#09;&#09;if(strncmp((char*)(&amp;data[i]),(char*)string2,string_length)==0) return &amp;data[i];<br/>
&#09;}<br/>
&#09;return 0;<br/>
}<br/>
int main(int argc, _TCHAR* argv[])<br/>
{<br/>
&#09;BSTR rootwmi=SysAllocString(L"root\\wmi");<br/>
&#09;BSTR tables=SysAllocString(L"MSSmBios_RawSMBiosTables");<br/>
&nbsp; &nbsp; BSTR biosdata=SysAllocString(L"SMBiosData");<br/>
<br/>
&#09;HRESULT hr=CoInitializeEx(0, COINIT_MULTITHREADED);<br/>
&#09;if(!SUCCEEDED(hr)) return 0;<br/>
&#09;IWbemLocator* pLoc=0;<br/>
&#09;hr=CoCreateInstance(CLSID_WbemLocator,0,CLSCTX_INPROC_SERVER,IID_IWbemLocator,(void**)&amp;pLoc);<br/>
&#09;if(!SUCCEEDED(hr))<br/>
&#09;{<br/>
&#09;&#09;CoUninitialize();<br/>
&#09;&#09;return 0;<br/>
&#09;}<br/>
&#09;IWbemServices* pSvc=0;<br/>
&#09;hr=pLoc-&gt;ConnectServer(rootwmi,0 ,0 ,0 ,0,0,0,&amp;pSvc);<br/>
&#09;if(!SUCCEEDED(hr))<br/>
&nbsp; &nbsp; {<br/>
&#09;&#09;pLoc-&gt;Release(); &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; CoUninitialize();<br/>
&nbsp; &nbsp; &nbsp; &nbsp; return 0;<br/>
&nbsp; &nbsp; }<br/>
&nbsp; &nbsp; hr=CoSetProxyBlanket(pSvc,RPC_C_AUTHN_WINNT,RPC_C_AUTHZ_NONE,0,RPC_C_AUTHN_LEVEL_CALL,RPC_C_IMP_LEVEL_IMPERSONATE,0,EOAC_NONE);<br/>
&#09;if(!SUCCEEDED(hr))<br/>
&#09;{<br/>
&#09; &nbsp; &nbsp;pSvc-&gt;Release();<br/>
&nbsp; &nbsp; &nbsp; &nbsp; pLoc-&gt;Release(); &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; CoUninitialize();<br/>
&nbsp; &nbsp; &nbsp; &nbsp; return 0;<br/>
&#09;}<br/>
<br/>
&nbsp; &nbsp; IEnumWbemClassObject* pEnum=0;<br/>
&nbsp; &nbsp; hr=pSvc-&gt;CreateInstanceEnum(tables,0,0, &amp;pEnum);<br/>
&#09;if(!SUCCEEDED(hr))<br/>
&#09;{<br/>
&#09; &nbsp; &nbsp;pSvc-&gt;Release();<br/>
&nbsp; &nbsp; &nbsp; &nbsp; pLoc-&gt;Release(); &nbsp; &nbsp; <br/>
&nbsp; &nbsp; &nbsp; &nbsp; CoUninitialize();<br/>
&nbsp; &nbsp; &nbsp; &nbsp; return 0;<br/>
&#09;}<br/>
<br/>
&#09;IWbemClassObject* pInstance=0;<br/>
&nbsp; &nbsp; unsigned long Count=0;<br/>
&nbsp; &nbsp; hr=pEnum-&gt;Next(WBEM_INFINITE,1,&amp;pInstance,&amp;Count);<br/>
&#09;if(SUCCEEDED(hr))<br/>
&#09;{&#09;&#09;<br/>
&#09;&#09; VARIANT BiosData;<br/>
&#09;&#09; VariantInit(&amp;BiosData);<br/>
&#09;&#09; CIMTYPE type;<br/>
&#09;&#09; hr=pInstance-&gt;Get(biosdata,0,&amp;BiosData,&amp;type,NULL);<br/>
&#09;&#09; if(SUCCEEDED(hr))<br/>
&#09;&#09; {<br/>
&#09;&#09;&#09;&#09; &nbsp; &nbsp; SAFEARRAY* p_array = NULL;<br/>
&#09;&#09;&#09;&#09; &nbsp; &nbsp; p_array = V_ARRAY(&amp;BiosData);<br/>
&#09;&#09;&#09;&#09;&#09; unsigned char* p_data=(unsigned char *)p_array-&gt;pvData;<br/>
&#09;&#09;&#09;&#09;&#09; unsigned long length=p_array-&gt;rgsabound[0].cElements;<br/>
&#09;&#09;&#09;&#09;&#09; AllToUpper(p_data,length);<br/>
&#09;&#09;&#09;&#09; &nbsp; &nbsp; unsigned char* x1=ScanDataForString((unsigned char*)p_data,length,(unsigned char*)"INNOTEK GMBH");<br/>
&#09;&#09;&#09;&#09; &nbsp; &nbsp; unsigned char* x2=ScanDataForString((unsigned char*)p_data,length,(unsigned char*)"VIRTUALBOX");<br/>
&#09;&#09;&#09;&#09;&#09; unsigned char* x3=ScanDataForString((unsigned char*)p_data,length,(unsigned char*)"SUN MICROSYSTEMS");<br/>
&#09;&#09;&#09;&#09;&#09; unsigned char* x4=ScanDataForString((unsigned char*)p_data,length,(unsigned char*)"VIRTUAL MACHINE");<br/>
&#09;&#09;&#09;&#09;&#09; unsigned char* x5=ScanDataForString((unsigned char*)p_data,length,(unsigned char*)"VBOXVER");<br/>
&#09;&#09;&#09;&#09;&#09; if(x1 || x2 || x3 || x4 || x5)<br/>
&#09;&#09;&#09;&#09;&#09; {<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp;printf("VirtualBox detected\r\n");<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp;printf("Some Strings found:\r\n");<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp;if(x1) printf("%s\r\n",x1);<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp;if(x2) printf("%s\r\n",x2);<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp;if(x3) printf("%s\r\n",x3);<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp;if(x4) printf("%s\r\n",x4);<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp;if(x5) printf("%s\r\n",x5);<br/>
&#09;&#09;&#09;&#09;&#09;}<br/>
&#09;&#09; }<br/>
&#09;&#09; VariantClear(&amp;BiosData);<br/>
&#09;&#09; pInstance-&gt;Release();<br/>
&#09;}<br/>
&#09;pSvc-&gt;Release();<br/>
&nbsp; &nbsp; pLoc-&gt;Release(); &nbsp; &nbsp; <br/>
&nbsp; &nbsp; CoUninitialize();<br/>
&nbsp; &nbsp; ExitProcess(0);<br/>
&#09;return 0;<br/>
}</body></html>