<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>9 Methods</title>
</head><body>//http://waleedassar.blogspot.com - (@waleedassar)<br/>
#include "stdafx.h"<br/>
#include "windows.h"<br/>
<br/>
<br/>
void ToLower(unsigned char* Pstr)<br/>
{<br/>
&#09;char* P=(char*)Pstr;<br/>
&#09;unsigned long length=strlen(P);<br/>
&#09;for(unsigned long i=0;i&lt;length;i++) P[i]=tolower(P[i]);<br/>
&#09;return;<br/>
}<br/>
<br/>
int main(int argc, char* argv[])<br/>
{<br/>
&#09;//method 1<br/>
&#09;HKEY HK=0;<br/>
&#09;if(RegOpenKeyEx(HKEY_LOCAL_MACHINE,"HARDWARE\\ACPI\\DSDT\\VBOX__",0,KEY_READ,&amp;HK)==ERROR_SUCCESS)<br/>
&#09;{<br/>
&#09;&#09;&#09;&#09;MessageBox(0,"VirtualBox detected","waliedassar",0);<br/>
&#09;&#09; &nbsp; &nbsp; &nbsp; &nbsp;ExitProcess(1);<br/>
&#09;}<br/>
<br/>
&#09;//method 2 -- requires Guest Additions to be installed.<br/>
&#09;HANDLE hF1=CreateFile("\\\\.\\VBoxMiniRdrDN",GENERIC_READ,FILE_SHARE_READ|FILE_SHARE_WRITE|FILE_SHARE_DELETE,0,OPEN_EXISTING,0,0);<br/>
&#09;if(hF1!=INVALID_HANDLE_VALUE)<br/>
&#09;{<br/>
&#09;&#09;MessageBox(0,"VirtualBox detected","waliedassar",0);<br/>
&#09;&#09;ExitProcess(2);<br/>
&#09;}<br/>
<br/>
<br/>
&#09;//method 3 -- requires Guest Additions to be installed<br/>
&#09;HMODULE hM1=LoadLibrary("VBoxHook.dll");<br/>
&#09;if(hM1)<br/>
&#09;{<br/>
&#09;&#09;MessageBox(0,"VirtualBox detected","waliedassar",0);<br/>
&#09;&#09;ExitProcess(3);<br/>
&#09;}<br/>
<br/>
&#09;//method 4 -- requires Guest Additions to be installed<br/>
&#09;HK=0;<br/>
&#09;if( (ERROR_SUCCESS==RegOpenKeyEx(HKEY_LOCAL_MACHINE,"SOFTWARE\\Oracle\\VirtualBox Guest Additions",0,KEY_READ,&amp;HK)) &amp;&amp; HK)<br/>
&#09;{<br/>
&#09;&#09;MessageBox(0,"VirtualBox detected","waliedassar",0);<br/>
&#09;&#09;RegCloseKey(HK);<br/>
&#09;&#09;ExitProcess(4);<br/>
&#09;}<br/>
<br/>
&#09;//method 5<br/>
&#09;HK=0;<br/>
&#09;char* subkey="SYSTEM\\CurrentControlSet\\Enum\\IDE";<br/>
&#09;if( (ERROR_SUCCESS==RegOpenKeyEx(HKEY_LOCAL_MACHINE,subkey,0,KEY_READ,&amp;HK)) &amp;&amp; HK )<br/>
&#09;{<br/>
&#09;&#09;unsigned long n_subkeys=0;<br/>
&#09;&#09;unsigned long max_subkey_length=0;<br/>
&#09;&#09;if(ERROR_SUCCESS==RegQueryInfoKey(HK,0,0,0,&amp;n_subkeys,&amp;max_subkey_length,0,0,0,0,0,0))<br/>
&#09;&#09;{<br/>
&#09;&#09;&#09;if(n_subkeys) &nbsp;//Usually n_subkeys are 2<br/>
&#09;&#09;&#09;{<br/>
&#09;&#09;&#09; &nbsp; &nbsp; &nbsp;char* pNewKey=(char*)LocalAlloc(LMEM_ZEROINIT,max_subkey_length+1);<br/>
&#09;&#09;&#09;&#09; &nbsp;for(unsigned long i=0;i&lt;n_subkeys;i++) &nbsp;//Usually n_subkeys are 2<br/>
&#09;&#09;&#09;&#09; &nbsp;{<br/>
&#09;&#09;&#09;&#09;&#09; &nbsp; &nbsp; &nbsp;memset(pNewKey,0,max_subkey_length+1);<br/>
&#09;&#09;&#09;&#09;&#09; &nbsp; &nbsp; &nbsp;HKEY HKK=0;<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(ERROR_SUCCESS==RegEnumKey(HK,i,pNewKey,max_subkey_length+1))<br/>
&#09;&#09;&#09;&#09;&#09;&#09; &nbsp;{<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp; if((RegOpenKeyEx(HK,pNewKey,0,KEY_READ,&amp;HKK)==ERROR_SUCCESS) &nbsp;&amp;&amp; HKK)<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp; {<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp; &nbsp; unsigned long nn=0;<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp; &nbsp; unsigned long maxlen=0;<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp; &nbsp; RegQueryInfoKey(HKK,0,0,0,&amp;nn,&amp;maxlen,0,0,0,0,0,0);<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;char* pNewNewKey=(char*)LocalAlloc(LMEM_ZEROINIT,maxlen+1);<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09; if(RegEnumKey(HKK,0,pNewNewKey,maxlen+1)==ERROR_SUCCESS)<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09; {<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp; &nbsp; &nbsp; HKEY HKKK=0;<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(RegOpenKeyEx(HKK,pNewNewKey,0,KEY_READ,&amp;HKKK)==ERROR_SUCCESS)<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp; {<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp; &nbsp; &nbsp; &nbsp;unsigned long size=0xFFF;<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp; &nbsp; &nbsp; &nbsp;unsigned char ValName[0x1000]={0};<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if(RegQueryValueEx(HKKK,"FriendlyName",0,0,ValName,&amp;size)==ERROR_SUCCESS)<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;{<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp; &nbsp; &nbsp; &nbsp; ToLower(ValName);<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp; &nbsp; &nbsp; &nbsp; if(strstr((char*)ValName,"vbox"))<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09; {<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp; &nbsp; &nbsp; &nbsp;MessageBox(0,"VirtualBox detected","waliedassar",0);<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp; &nbsp; &nbsp; &nbsp;ExitProcess(5);<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09; }<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;}<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;RegCloseKey(HKKK);<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp; }<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09; }<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09; LocalFree(pNewNewKey);<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09; RegCloseKey(HKK);<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp; }<br/>
&#09;&#09;&#09;&#09;&#09;&#09; &nbsp;}<br/>
&#09;&#09;&#09;&#09; &nbsp;}<br/>
&#09;&#09;&#09;&#09; &nbsp;LocalFree(pNewKey);<br/>
&#09;&#09;&#09;}<br/>
&#09;&#09;}<br/>
&#09;&#09;RegCloseKey(HK);<br/>
&#09;}<br/>
<br/>
&#09;//method 6<br/>
&#09;HK=0;<br/>
&#09;if(RegOpenKeyEx(HKEY_LOCAL_MACHINE,"HARDWARE\\DESCRIPTION\\System",0,KEY_READ,&amp;HK)==ERROR_SUCCESS)<br/>
&#09;{<br/>
&#09;&#09;unsigned long type=0;<br/>
&#09;&#09;unsigned long size=0x100;<br/>
&#09;&#09;char* systembiosversion=(char*)LocalAlloc(LMEM_ZEROINIT,size+10);<br/>
&#09;&#09;if(ERROR_SUCCESS==RegQueryValueEx(HK,"SystemBiosVersion",0,&amp;type,(unsigned char*)systembiosversion,&amp;size))<br/>
&#09;&#09;{<br/>
&#09;&#09;&#09; &nbsp;ToLower((unsigned char*)systembiosversion);<br/>
&#09;&#09;&#09; &nbsp;if(type==REG_SZ||type==REG_MULTI_SZ)<br/>
&#09;&#09;&#09; &nbsp;{<br/>
&#09;&#09;&#09;&#09;&#09; &nbsp;if(strstr(systembiosversion,"vbox"))<br/>
&#09;&#09;&#09;&#09;&#09; &nbsp;{<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;MessageBox(0,"VirtualBox detected","waliedassar",0);<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;ExitProcess(6);&#09;<br/>
&#09;&#09;&#09;&#09;&#09; &nbsp;}<br/>
&#09;&#09;&#09; &nbsp;}<br/>
&#09;&#09;}<br/>
&#09;&#09;LocalFree(systembiosversion);<br/>
<br/>
&#09;&#09;type=0;<br/>
&#09;&#09;size=0x200;<br/>
&#09;&#09;char* videobiosversion=(char*)LocalAlloc(LMEM_ZEROINIT,size+10);<br/>
&#09;&#09;if(ERROR_SUCCESS==RegQueryValueEx(HK,"VideoBiosVersion",0,&amp;type,(unsigned char*)videobiosversion,&amp;size))<br/>
&#09;&#09;{<br/>
&#09;&#09;&#09;if(type==REG_MULTI_SZ)<br/>
&#09;&#09;&#09;{<br/>
&#09;&#09;&#09;&#09;char* video=videobiosversion;<br/>
&#09;&#09;&#09;&#09;while(*(unsigned char*)video)<br/>
&#09;&#09;&#09;&#09;{<br/>
&#09;&#09;&#09;&#09;&#09;ToLower((unsigned char*)video);<br/>
&#09;&#09;&#09;&#09;&#09;if(strstr(video,"oracle")||strstr(video,"virtualbox") )<br/>
&#09;&#09;&#09;&#09;&#09;{<br/>
&#09;&#09;&#09;&#09;&#09;&#09; &nbsp;&#09;&#09;&#09;MessageBox(0,"VirtualBox detected","waliedassar",0);<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;ExitProcess(6);&#09;<br/>
&#09;&#09;&#09;&#09;&#09;}<br/>
&#09;&#09;&#09;&#09;&#09;video=&amp;video[strlen(video)+1];<br/>
&#09;&#09;&#09;&#09;}<br/>
&#09;&#09;&#09;}<br/>
&#09;&#09;}<br/>
&#09;&#09;LocalFree(videobiosversion);<br/>
&#09;&#09;RegCloseKey(HK);<br/>
&#09;}<br/>
&#09;//method 7 - requires guest additions to be installed.<br/>
&#09;HANDLE hxx=CreateFile("\\\\.\\pipe\\VBoxTrayIPC",GENERIC_READ,FILE_SHARE_READ|FILE_SHARE_WRITE,0,OPEN_EXISTING,0,0);<br/>
&#09;if(hxx!=INVALID_HANDLE_VALUE)<br/>
&#09;{<br/>
&#09;&#09;&#09;MessageBox(0,"VirtualBox detected","waliedassar",0);<br/>
&#09;&#09;&#09;CloseHandle(hxx);<br/>
&#09;&#09;&#09;ExitProcess(7);<br/>
&#09;}<br/>
&nbsp; &nbsp; &nbsp; &nbsp; //method 8 - requires guest additions installed<br/>
&nbsp; &nbsp; &nbsp; &nbsp;&#09;HWND hY1=FindWindow("VBoxTrayToolWndClass",0);<br/>
&#09;HWND hY2=FindWindow(0,"VBoxTrayToolWnd");<br/>
&#09;if(hY1 || hY2)<br/>
&#09;{<br/>
&#09;&#09;MessageBox(0,"VirtualBox detected","waliedassar",0);<br/>
&#09;&#09;ExitProcess(8);<br/>
&#09;}<br/>
&#09;<br/>
&nbsp; &nbsp; &nbsp; &nbsp;//method 9<br/>
&nbsp; &nbsp; &nbsp; &nbsp;unsigned long pnsize=0x1000;<br/>
&nbsp; &nbsp; &nbsp; &nbsp;char* provider=(char*)LocalAlloc(LMEM_ZEROINIT,pnsize);<br/>
&nbsp; &nbsp; &nbsp; &nbsp;int retv=WNetGetProviderName(WNNC_NET_RDR2SAMPLE,provider,&amp;pnsize);<br/>
&nbsp; &nbsp; &nbsp; &nbsp;if(retv==NO_ERROR)<br/>
&nbsp; &nbsp; &nbsp; &nbsp;{<br/>
&#09;&#09;if(lstrcmpi(provider,"VirtualBox Shared Folders")==0)<br/>
&#09;&#09;{<br/>
&#09;&#09;&#09;MessageBox(0,"VirtualBox detected","waliedassar",0);<br/>
&#09;&#09;&#09;ExitProcess(9);<br/>
&#09;&#09;}<br/>
&nbsp; &nbsp; &nbsp; &nbsp;}<br/>
&nbsp; &nbsp; &nbsp; &nbsp;return 0;<br/>
}</body></html>