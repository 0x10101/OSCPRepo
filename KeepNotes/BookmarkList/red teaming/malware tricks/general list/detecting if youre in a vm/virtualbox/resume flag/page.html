<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Resume Flag</title>
</head><body>//http://waleedassar.blogspot.com<br/>
//http://www.twitter.com/waleedassar<br/>
//Use this code to detect if Windows XP is running inside Virtual PC 2007<br/>
#include "stdafx.h"<br/>
#include "windows.h"<br/>
#include "stdio.h"<br/>
<br/>
#define CONTEXT_ALL 0x1003F<br/>
<br/>
int dummy(int);<br/>
unsigned long gf=0;<br/>
int __cdecl Handler(EXCEPTION_RECORD* pRec,void* est,unsigned char* pContext,void* disp)<br/>
{<br/>
&#09;if(pRec-&gt;ExceptionCode==0xC0000096) &nbsp;//Privileged instruction<br/>
&#09;{<br/>
&#09;&#09;//---------------------Installing the trick--------------------------------------<br/>
&#09;&#09;*(unsigned long*)(pContext)=CONTEXT_ALL;/*CONTEXT_DEBUG_REGISTERS|CONTEXT_FULL*/<br/>
&#09;&#09;*(unsigned long*)(pContext+0x4)=(unsigned long)(&amp;dummy); <br/>
&#09;&#09;*(unsigned long*)(pContext+0x8)=(unsigned long)(&amp;dummy);<br/>
&#09;&#09;*(unsigned long*)(pContext+0xC)=(unsigned long)(&amp;dummy);<br/>
&#09;&#09;*(unsigned long*)(pContext+0x10)=(unsigned long)(&amp;dummy);<br/>
&#09;&#09;*(unsigned long*)(pContext+0x14)=0;<br/>
&#09;&#09;*(unsigned long*)(pContext+0x18)=0x155; //Enable the four DRx On-Execute<br/>
&#09;&#09;//---------------------------------------------------------------------------------<br/>
&#09;&#09;(*(unsigned long*)(pContext+0xB8))++;<br/>
&#09;&#09;return ExceptionContinueExecution;<br/>
&#09;}<br/>
&#09;else if(pRec-&gt;ExceptionCode==EXCEPTION_SINGLE_STEP)<br/>
&#09;{<br/>
&#09;&#09;if(gf==1)<br/>
&#09;&#09;{<br/>
&#09;&#09;&#09; &nbsp; MessageBox(0,"Expected behavior (XP)","waliedassar",0);<br/>
&#09;&#09;&#09; &nbsp; ExitProcess(0);<br/>
&#09;&#09;}<br/>
&#09;&#09;gf++;<br/>
&#09;&#09;(*(unsigned long*)(pContext+0xC0))|=0x00010000; //Set the RF (Resume Flag)<br/>
&#09;&#09;return ExceptionContinueExecution;<br/>
&#09;}<br/>
&#09;return ExceptionContinueSearch;<br/>
}<br/>
<br/>
int dummy(int x)<br/>
{<br/>
&#09;x+=0x100;<br/>
&#09;return x;<br/>
}<br/>
<br/>
int main(int shitArg)<br/>
{<br/>
&#09;unsigned long ver_=GetVersion();<br/>
&#09;unsigned long major=ver_&amp;0xFF;<br/>
&#09;unsigned long minor=(ver_&gt;&gt;0x8)&amp;0xFF;<br/>
&#09;if(major==0x05 &amp; minor==0x01) //Windows XP<br/>
&#09;{<br/>
&#09; &nbsp; &nbsp;unsigned long x=0;<br/>
&#09; &nbsp; &nbsp;__asm<br/>
&#09;&#09;{<br/>
&#09;&#09; &nbsp; push offset Handler<br/>
&#09;&#09; &nbsp; push dword ptr fs:[0x0]<br/>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mov dword ptr fs:[0x0],esp<br/>
&#09;&#09; &nbsp; STI; Triggers an exception(privileged instruction)<br/>
&#09;&#09;}<br/>
&#09; &nbsp; &nbsp;dummy(0xFF);<br/>
&#09;&#09;__asm<br/>
&#09;&#09;{<br/>
&#09;&#09;&#09;pop dword ptr fs:[0x0]<br/>
&#09;&#09;&#09;pop ebx<br/>
&#09;&#09;}<br/>
&#09;&#09;MessageBox(0,"Virtual PC 2007 detected (XP)","waliedassar",0);<br/>
&#09;}<br/>
&#09;return 0;<br/>
}</body></html>