<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>SMBiosData</title>
</head><body>//http://waleedassar.blogspot.com (@waleedassar)<br/>
//The following code parses the SMBiosData retrieved from the Windows registry and searches for any structures of TYPE TYPE_INACTIVE (126, 0x7E). This is a sign of VirtualBox existence.<br/>
#include "stdafx.h"<br/>
#include "windows.h"<br/>
#include "stdio.h"<br/>
<br/>
#define TYPE_BIOS 0x0 &nbsp; &nbsp;//e.g. Bios Brand and Version<br/>
#define TYPE_SYSTEM 0x1 &nbsp;//System Manufacturer and Model<br/>
#define TYPE_BASEBOARD 0x2<br/>
#define TYPE_SYSTEM_ENCLOSURE 0x3<br/>
#define TYPE_PROCESSOR 0x4<br/>
#define TYPE_CACHE_INFO 0x7<br/>
#define TYPE_SYSTEM_SLOTS 0x9<br/>
#define TYPE_OEM_STRINGS 0xB<br/>
#define TYPE_PHYSICAL_MEM_ARRAY 0x10<br/>
#define TYPE_MEMORY_DEVICE &nbsp; &nbsp;0x11<br/>
#define TYPE_MEMORY_ARRAY_MAPPED_ADDRESS 0x13<br/>
#define TYPE_SYSTEM_BOOT_INFORMATION 0x20<br/>
#define TYPE_INACTIVE 0x7E //???? this one<br/>
#define TYPE_END_OF_STRUCTURE 0x7F<br/>
<br/>
//----This structure is only need for parsing SMBiosData retrieved from Registry.<br/>
//Not needed for parsing SMBiosData retrieved Via WMI<br/>
struct BIOS_DATA_HEAD<br/>
{<br/>
&#09;unsigned char a1;<br/>
&#09;unsigned char a2;<br/>
&#09;unsigned char a3;<br/>
&#09;unsigned char a4;<br/>
&#09;unsigned long length;<br/>
};<br/>
<br/>
struct HeadER<br/>
{<br/>
&#09;unsigned char Type; &nbsp;//0 for bios, 1 for system, and so on.<br/>
&#09;unsigned char section_length;<br/>
&#09;unsigned short handles;<br/>
};<br/>
<br/>
void AllToUpper(char* str,unsigned long len)<br/>
{<br/>
&#09;for(unsigned long c=0;c&lt;len;c++)<br/>
&#09;{<br/>
&#09;&#09;if(str[c]&gt;='a' &amp;&amp; str[c]&lt;='z')<br/>
&#09;&#09;{<br/>
&#09;&#09;&#09;str[c]-=32;<br/>
&#09;&#09;}<br/>
&#09;}<br/>
}<br/>
<br/>
void PrintType(unsigned char type)<br/>
{<br/>
&#09; printf("----------------------------------------\r\n");<br/>
&#09; if(type==TYPE_BIOS) printf("Type: BIOS\r\n");<br/>
&#09; else if(type==TYPE_SYSTEM) printf("Type: SYSTEM INFO\r\n");<br/>
&#09; else if(type==TYPE_BASEBOARD) printf("Type: BASEBOARD\r\n");<br/>
&#09; else if(type==TYPE_SYSTEM_ENCLOSURE) printf("Type: BIOS\r\n");<br/>
&#09; else if(type==TYPE_PROCESSOR) printf("Type: PROCESSOR\r\n");<br/>
&#09; else if(type==TYPE_CACHE_INFO) printf("Type: CACHE INFO\r\n");<br/>
&#09; else if(type==TYPE_SYSTEM_SLOTS) printf("Type: SYSTEM SLOTS\r\n");<br/>
&#09; else if(type==TYPE_OEM_STRINGS) printf("Type: OEM STRINGS\r\n");<br/>
&#09; else if(type==TYPE_PHYSICAL_MEM_ARRAY) printf("Type: PHYSICAL MEMORY ARRAY\r\n");<br/>
&#09; else if(type==TYPE_MEMORY_DEVICE) printf("Type: MEMORY DEVICE\r\n");<br/>
&#09; else if(type==TYPE_MEMORY_ARRAY_MAPPED_ADDRESS) printf("Type: MEMORY ARRAY MAPPED ADDRESS\r\n");<br/>
&#09; else if(type==TYPE_SYSTEM_BOOT_INFORMATION) printf("Type: SYSTEM BOOT INFORMATION\r\n");<br/>
&#09; else if(type==TYPE_END_OF_STRUCTURE) &nbsp; printf("Type: END OF STRUCTURE\r\n");<br/>
&#09; else printf("Type: %X\r\n",type);<br/>
}<br/>
//index 1 represents the first string<br/>
char* PrintString(char* pString,unsigned long index)<br/>
{<br/>
&#09;index--;<br/>
&#09;while(index)<br/>
&#09;{<br/>
&#09;&#09;unsigned long length=strlen(pString);<br/>
&#09;&#09;pString+=(length+1);<br/>
&#09;&#09;if(*pString==0)<br/>
&#09;&#09;{<br/>
&#09;&#09;&#09;printf("String is: Error retrieving string\r\n");<br/>
&#09;&#09;&#09;return 0;<br/>
&#09;&#09;}<br/>
&#09;&#09;index--;<br/>
&#09;}<br/>
&#09;printf("String is: %s\r\n",pString);<br/>
&#09;return pString;<br/>
}<br/>
<br/>
unsigned char* ScanDataForString(unsigned char* data,unsigned long data_length,unsigned char* string2)<br/>
{<br/>
&#09;unsigned long string_length=strlen((char*)string2);<br/>
&#09;for(unsigned long i=0;i&lt;=(data_length-string_length);i++)<br/>
&#09;{<br/>
&#09;&#09;if(strncmp((char*)(&amp;data[i]),(char*)string2,string_length)==0) return &amp;data[i];<br/>
&#09;}<br/>
&#09;return 0;<br/>
}<br/>
<br/>
int main(int argc, char* argv[])<br/>
{<br/>
&#09;HKEY hk=0;<br/>
&#09;int ret=RegOpenKeyEx(HKEY_LOCAL_MACHINE,"SYSTEM\\CurrentControlSet\\Services\\mssmbios\\data",0,KEY_ALL_ACCESS,&amp;hk);<br/>
&#09;if(ret==ERROR_SUCCESS)<br/>
&#09;{<br/>
&#09;&#09;unsigned long type=0;<br/>
&#09;&#09;unsigned long length=0;<br/>
&#09;&#09;ret=RegQueryValueEx(hk,"SMBiosData",0,&amp;type,0,&amp;length);<br/>
&#09;&#09;if(ret==ERROR_SUCCESS)<br/>
&#09;&#09;{<br/>
&#09;&#09;&#09;if(length)<br/>
&#09;&#09;&#09;{<br/>
&#09;&#09;&#09;&#09;char* p=(char*)LocalAlloc(LMEM_ZEROINIT,length);<br/>
&#09;&#09;&#09;&#09;if(p)<br/>
&#09;&#09;&#09;&#09;{<br/>
&#09;&#09;&#09;&#09;&#09;ret=RegQueryValueEx(hk,"SMBiosData",0,&amp;type,(unsigned char*)p,&amp;length);<br/>
&#09;&#09;&#09;&#09;&#09;if(ret==ERROR_SUCCESS)<br/>
&#09;&#09;&#09;&#09;&#09;{<br/>
&#09;&#09;&#09;&#09;&#09;&#09;//--------------------------Only when parsing SMBiosData retrieved from Registry------------------<br/>
&#09;&#09;&#09;&#09;&#09;&#09;unsigned long new_length=((BIOS_DATA_HEAD*)p)-&gt;length; &nbsp;//length-8<br/>
&#09;&#09;&#09;&#09;&#09;&#09;p+=0x8;<br/>
&#09;&#09;&#09;&#09;&#09;&#09;printf("Length is: %X\r\n",new_length);<br/>
&#09;&#09;&#09;&#09;&#09;&#09;//------------------------------------------------------------------------------------------------<br/>
&#09;&#09;&#09;&#09;&#09;&#09;unsigned long i=0;<br/>
&#09;&#09;&#09;&#09;&#09;&#09;while(i&lt;new_length)<br/>
&#09;&#09;&#09;&#09;&#09;&#09;{<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;unsigned char type=((HeadER*)(p+i))-&gt;Type;<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;PrintType(type);<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;unsigned char section_size=((HeadER*)(p+i))-&gt;section_length;<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;printf("Section length is: %X\r\n",section_size);<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;unsigned short handles=((HeadER*)(p+i))-&gt;handles;<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;printf("Handle is: %X\r\n",handles);<br/>
<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;if(type==0x7F) break; //End-Of-Table<br/>
<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;if(type==TYPE_INACTIVE) //0x7E<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;{<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp; &nbsp;PrintString(p+i+section_size,*(p+i+4)); &nbsp; //print Brand<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09; &nbsp; &nbsp;PrintString(p+i+section_size,*(p+i+5)); &nbsp; //print Version<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;&#09;MessageBox(0,"VirtualBox detected","waliedassar",0);<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;}<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;//---Get End of Structure--------------<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;unsigned char* pxp=(unsigned char*)p+i+section_size;<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;while(*(unsigned short*)pxp!=0) pxp++;<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;pxp++;<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;pxp++;<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;//-------------------------------------<br/>
&#09;&#09;&#09;&#09;&#09;&#09;&#09;i=(pxp-((unsigned char*)p));<br/>
&#09;&#09;&#09;&#09;&#09;&#09;}<br/>
&#09;&#09;&#09;&#09;&#09;}<br/>
&#09;&#09;&#09;&#09;&#09;LocalFree(p);<br/>
&#09;&#09;&#09;&#09;}<br/>
&#09;&#09;&#09;}<br/>
&#09;&#09;}<br/>
&#09;&#09;RegCloseKey(hk);<br/>
&#09;}<br/>
&#09;return 0;<br/>
}</body></html>