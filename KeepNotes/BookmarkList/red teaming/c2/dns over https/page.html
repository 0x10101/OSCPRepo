<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>DNS Over HTTPS</title>
</head><body>https://blog.redteam.pl/2019/04/dns-based-threat-hunting-and-doh.html<br/>
<br/>
tl;dr: use DoH with domain fronting as an interesting, less detected/suspicious C2 channel.<br/>
<br/>
<span style="font-size: 10pt"><span style="font-family: sans">Malicious communication over encrypted HTTPS channel is in fact nothing new, but DoH (DNS Queries over HTTPS [<a href="https://tools.ietf.org/html/rfc8484"><span style="color: #1155cc">https://tools.ietf.org/html/rfc8484</span></a>]) can help a lot in hiding communication with C&amp;C (a.k.a. C2). What is new in this case and changes a lot, is that well known and trusted vendors such as Google, CloudFlare etc are starting to run its own DoH services. This new future can be used by red teamers as well as abused by threat actors such as attackers, malware creators etc. &nbsp;<br/>
<br/>
<b>Summary &nbsp;</b><br/>
From one side it is better for user privacy when there are solutions like DoH in place, on the other hand it is harder to detect leaks with i.a. DLP (Data Leak Prevention) tools. This also shows that products such as DNS firewalls are not enough for organisations to protect against hackers. Threat actors are still able to use hardcoded domains or DGA in malware but with DoH it will be not detected with today’s DNS firewall solutions. Currently when attacker is using his own DNS server and the traffic is not encrypted, we can simply detect it by additional inspection of DNS related network traffic, not only DNS queries/logs from our service.<b>&nbsp;With DoH we will see HTTPS communication to i.a. google.com, not even knowing that it is a DNS query.</b>&nbsp;This is not only a way to send hidden DNS queries but a great approach to leak data outside the organisation network without being detected. The need arises to perform real threat hunting, not just use products advertised with buzzwords. Detection needs to be based on knowledge from the top of The Pyramid of Pain – Tactics, Techniques and Procedures (TTPs). Threat hunters need to think like highly skilled threat actors, not only to detect well known and common techniques which are usually used only by low skilled attackers, such as script kiddies. &nbsp;<b><br/>
</b>&nbsp; Threat hunters need to have similar skills as red teamers, and vice versa, if red teamers want to keep up and perform simulations of attacks that can go undetected. Good example on how NOT to do simulation of attacks is mentioned above The "LAME" technique – it sounds great but in fact it makes detection easier compared to a case when there is no such technique in use and attackers don’t encrypt communication in the internal network. Most organizations don’t store LAN traffic, but even if they are, this is about not being detected (successful attack) vs. leave more forensics artifacts, and we are talking primarily about post-exploitation and lateral movement artifacts, which most likely will not be connected to any external resources – which approach you will choose as an attacker, leave more forensics evidence or be able to perform a successful attack without detection during the ongoing engagement? Using DoH with domain fronting creates a real problem for detection in a common environment, in fact just because it will be possible to establish malicious communication over a trusted vendors as proxy. We can check time (outside of working hours), compare time between requests etc but there is no obvious alert just for DoH without encountering many false positives. Anyway threat hunting is not about detecting all the things, it should trigger alerts which almost never are false positives, it should detect some stages of attacks but don’t need to detect all, i.a. because of computing power and having more false positives, which can drop our guard ending in overlooking a real attack. &nbsp;<br/>
<br/>
References &nbsp; </span></span><ul><span style="font-size: 10pt"><span style="font-family: sans"><li>&nbsp;<span style="color: #1155cc"><a href="https://developers.google.com/speed/public-dns/docs/dns-over-https">https://developers.google.com/speed/public-dns/docs/dns-over-https</a></span>&nbsp;</li>
<li>&nbsp;<span style="color: #1155cc"><a href="https://developers.cloudflare.com/1.1.1.1/dns-over-https/json-format/">https://developers.cloudflare.com/1.1.1.1/dns-over-https/json-format/</a></span>&nbsp;</li>
<li>&nbsp;<span style="color: #1155cc"><a href="https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/doh-dns-over-https-poses-possible-risks-to-enterprises/">https://www.trustwave.com/en-us/resources/blogs/spiderlabs-blog/doh-dns-over-https-poses-possible-risks-to-enterprises/</a></span>&nbsp;</li>
</span></span><li><span style="font-size: 10pt"><span style="font-family: sans">&nbsp;<span style="color: #1155cc"><a href="https://github.com/SpiderLabs/DoHC2/blob/master/Mitre_Attackcon_Playing_Devils_Advocate_With_Attack_1.0.pdf">https://github.com/SpiderLabs/DoHC2/blob/master/Mitre_Attackcon_Playing_Devils_Advocate_With_Attack_1.0.pdf</a></span>&nbsp;</span></span></li>
</ul>
&nbsp;</body></html>