<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Restricted Admin Mode and RDP</title>
</head><body>This is basically to add another mitigation for Pass the Hash attacks and will allow admins to more easily connect to systems to locally administer them without having to worry about exposing their credentials to that weaker/less secure system. &nbsp;Some good examples would be Help Desk personnel connecting to various workstations could utilize this without having to worry about losing/needing to change their passwords after the session, another good one would be a Domain Admin for some reason needing to connect to a member server to do some needed administration work for some reason.<br/>
<br/>
So the setting comes in the form of a new command line switch for MSTSC.exe. &nbsp;If you run mstsc /? you will have the following a new option:<br/>
<br/>
/restrictedAdmin -- Connects you to the remote PC or server in Restricted Administration mode. In this mode credentials won't be sent to the remote PC or server, which can protect you if you connect to a PC that has been compromised. However, connections made from the remote PC might not be authenticated by other PCs and servers, which might impact app functionality and compatibility. Implies /admin<br/>
<br/>
The first thing I see after connecting to my remote box that looks new is the bar up top.<br/>
<br/>
<img src="image.png" /><br/>
<br/>
We have a little padlock on it so check that out and it says we verified the target using Kerberos. &nbsp;Great!! however that is not what restrictedAdmin is about so lets dig a little further.<br/>
<br/>
However I heard that once you try to leave the box you are doing so in the context of the computer account so lets check that out. &nbsp;So I attempted to open \\pfes3ms4\C$ (Domain Controller) and immediately get an authentication prompt which shouldn’t happen if I truly am a EA/DA account so what gives?<br/>
<br/>
So from this perspective I can see that an SMB TREE CONNECT request came in for \\pfes3ms4\c$ and we are getting denied access. &nbsp;If I knew my SMB2 parsing better here I might be able to tell which account I am seeing from the originating system but I don’t so I went to the security audit log to see what we see on the receiving side when this occurs<br/>
<br/>
The security event log in turn shows me that this is NOT my FOREST\kurt account attempting to logon to the share but is instead the computer account PFES3MS5$ coming across the wire to access the share. &nbsp;So from an audit perspective now if I see failed attempts for resources from a computer account it could either be malware/legitimate services running in the system context OR it could be an admin using /restrictedadmin mode who tried to access something across the network while forgetting he/she was in restricted admin mode.<br/>
<br/>
So what about auditing on the local target system of a restrictedadmin session what does that look like compared to a regular TS session?<br/>
<br/>
<br/>
Actually it looks pretty normal. &nbsp;I’m still seeing a Logon Type = 10 i.e. Terminal Server logon and the account is still my account no funkiness with the computer account etc so from an auditing perspective in my SIEM’s etc I can still expect to look for the same things. &nbsp;Now whether or not there is some attribute that points out that the connection was a remoteadmin one or not I cannot seem to find unfortunately although there may be a way to do that.<br/>
<br/>
On another note it was mentioned at the Blackhat presentation that this was possibly controllable via a GPO i.e. you might be able to set a GPO on a group of say workstations and either say it’s require to use restrictedadmin to connect to them or perhaps you could force it on users that they are required to use restrictedadmin to connect to remote systems? &nbsp;Either way I looked through what I believe was every RDS setting on both the user and computer sides of GPO’s for 8.1/2012 R2 and have not been able to find such functionality so either I’m just missing it or possibly that’s a feature that will be forthcoming in a future build.<br/>
<br/>
Edit 11/4/2013<br/>
<br/>
Had another engineer point out the GPO setting for controlling this finally to me so adding that in here as well, shown in the picture below. This controls the RDP client itself so would apply this to the initiating system for a connection not the connection receiving machine. &nbsp;Example if I had 8.1 clients all over my network it would be a good idea to force this setting on my helpdesk personnel systems so that when they RDP to client systems they would be forced to use Restricted Admin mode. &nbsp;I have yet to test this setting out but have it here for completeness sake.<br/>
<br/>
<img src="image 2.png" /><br/>
<br/>
<br/>
In general this is a great new feature and a good step towards limiting credential theft via PtH tools. &nbsp;Unfortunately at the onset this is definitely going to require 8.1/2012 R2 so unless we end up doing some backporting may not be immediately useful in your environment until you get those 8.1 migrations rolling Smile .</body></html>